@page "/tasks"
@inject TaskService TaskService
@inject TagService TagService
@inject UserService UserService
@inject NavigationManager NavigationManager

<PageTitle>Tasks - ChildCare Connect</PageTitle>

<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900" style="font-family: 'Nunito', sans-serif;">Tasks</h1>
            <p class="text-gray-500 mt-1">Manage and track your assigned tasks.</p>
        </div>
        <button @onclick="() => OpenTaskModal(null)" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            New Task
        </button>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
        <div class="flex flex-wrap gap-4">
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Status:</label>
                <select @bind="statusFilter" @bind:after="LoadTasks" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                    <option value="All">All</option>
                    @foreach (var status in TaskItemStatus.All)
                    {
                        <option value="@status">@status</option>
                    }
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">Priority:</label>
                <select @bind="priorityFilter" @bind:after="LoadTasks" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                    <option value="All">All</option>
                    @foreach (var priority in TaskPriority.All)
                    {
                        <option value="@priority">@priority</option>
                    }
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-600">View:</label>
                <select @bind="viewFilter" @bind:after="LoadTasks" class="px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                    <option value="my">My Tasks</option>
                    <option value="all">All Tasks</option>
                </select>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center py-12">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div>
        </div>
    }
    else if (!tasks.Any())
    {
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-12 text-center">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
            <p class="text-gray-500 mb-4">Get started by creating your first task.</p>
            <button @onclick="() => OpenTaskModal(null)" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium">
                Create Task
            </button>
        </div>
    }
    else
    {
        <div class="space-y-4">
            @foreach (var task in tasks)
            {
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="text-lg font-semibold text-gray-900">@task.Title</h3>
                                <span class="@GetPriorityClass(task.Priority)">@task.Priority</span>
                                <span class="@GetStatusClass(task.Status)">@task.Status</span>
                            </div>
                            @if (!string.IsNullOrEmpty(task.Description))
                            {
                                <p class="text-gray-600 mb-3">@task.Description</p>
                            }
                            <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                                @if (task.DueDate.HasValue)
                                {
                                    <div class="flex items-center gap-1 @(task.DueDate < DateTime.UtcNow && task.Status != "Completed" ? "text-red-600" : "")">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                        </svg>
                                        <span>Due: @task.DueDate.Value.ToString("MMM d, yyyy")</span>
                                    </div>
                                }
                                <div class="flex items-center gap-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                    </svg>
                                    <span>Assigned to: @(task.Assignee?.Name ?? "Unassigned")</span>
                                </div>
                                @if (task.Creator != null)
                                {
                                    <div class="flex items-center gap-1">
                                        <span>Created by: @task.Creator.Name</span>
                                    </div>
                                }
                            </div>
                            @if (task.TaskTags.Any())
                            {
                                <div class="flex flex-wrap gap-2 mt-3">
                                    @foreach (var taskTag in task.TaskTags)
                                    {
                                        <span class="@GetTagClass(taskTag.Tag?.Color ?? "gray")">
                                            @taskTag.Tag?.Name
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                        <div class="flex items-center gap-2 ml-4">
                            @if (task.Status != "Completed")
                            {
                                <button @onclick="() => UpdateStatus(task, GetNextStatus(task.Status))" 
                                        class="p-2 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition-colors"
                                        title="@(task.Status == "Pending" ? "Start Task" : "Complete Task")">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                            }
                            <button @onclick="() => OpenTaskModal(task)" class="p-2 text-gray-400 hover:text-teal-600 hover:bg-teal-50 rounded-lg transition-colors" title="Edit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button @onclick="() => DeleteTask(task)" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@if (showModal)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" @onclick="CloseModal">
        <div class="bg-white rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto" @onclick:stopPropagation>
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">@(editingTask == null ? "Create Task" : "Edit Task")</h2>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                    <input type="text" @bind="taskForm.Title" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Task title" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea @bind="taskForm.Description" rows="3" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Task description"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select @bind="taskForm.Priority" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            @foreach (var priority in TaskPriority.All)
                            {
                                <option value="@priority">@priority</option>
                            }
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select @bind="taskForm.Status" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                            @foreach (var status in TaskItemStatus.All)
                            {
                                <option value="@status">@status</option>
                            }
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                    <input type="date" @bind="taskForm.DueDate" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Assign To *</label>
                    <select @bind="taskForm.AssigneeId" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                        <option value="">Select user...</option>
                        @foreach (var user in users)
                        {
                            <option value="@user.Id">@user.Name (@user.Role)</option>
                        }
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags</label>
                    <div class="flex flex-wrap gap-2">
                        @foreach (var tag in allTags)
                        {
                            <button type="button" 
                                    @onclick="() => ToggleTag(tag.Id)"
                                    class="@(selectedTagIds.Contains(tag.Id) ? GetTagClassSelected(tag.Color) : GetTagClassUnselected(tag.Color))">
                                @tag.Name
                            </button>
                        }
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-200 flex justify-end gap-3">
                <button @onclick="CloseModal" class="px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">
                    Cancel
                </button>
                <button @onclick="SaveTask" disabled="@isSaving" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium disabled:opacity-50">
                    @(isSaving ? "Saving..." : (editingTask == null ? "Create Task" : "Save Changes"))
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<TaskItem> tasks = new();
    private List<User> users = new();
    private List<Tag> allTags = new();
    private string statusFilter = "All";
    private string priorityFilter = "All";
    private string viewFilter = "my";
    private bool isLoading = true;
    private bool showModal = false;
    private bool isSaving = false;
    private TaskItem? editingTask;
    private TaskItem taskForm = new();
    private List<string> selectedTagIds = new();
    private string? currentUserId;

    protected override async Task OnInitializedAsync()
    {
        users = await UserService.GetAllUsersAsync();
        allTags = await TagService.GetAllTagsAsync();
        
        var currentUser = users.FirstOrDefault(u => u.Role == "Admin") ?? users.FirstOrDefault();
        currentUserId = currentUser?.Id;
        
        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        isLoading = true;
        StateHasChanged();
        
        if (viewFilter == "my" && currentUserId != null)
        {
            tasks = await TaskService.GetTasksForUserAsync(currentUserId, statusFilter, priorityFilter);
        }
        else
        {
            tasks = await TaskService.GetAllTasksAsync(statusFilter, priorityFilter);
        }
        
        isLoading = false;
        StateHasChanged();
    }

    private void OpenTaskModal(TaskItem? task)
    {
        editingTask = task;
        if (task != null)
        {
            taskForm = new TaskItem
            {
                Title = task.Title,
                Description = task.Description,
                Priority = task.Priority,
                Status = task.Status,
                DueDate = task.DueDate,
                AssigneeId = task.AssigneeId
            };
            selectedTagIds = task.TaskTags.Select(tt => tt.TagId).ToList();
        }
        else
        {
            taskForm = new TaskItem
            {
                Priority = "Normal",
                Status = "Pending",
                AssigneeId = currentUserId ?? ""
            };
            selectedTagIds = new List<string>();
        }
        showModal = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        showModal = false;
        editingTask = null;
        StateHasChanged();
    }

    private void ToggleTag(string tagId)
    {
        if (selectedTagIds.Contains(tagId))
        {
            selectedTagIds.Remove(tagId);
        }
        else
        {
            selectedTagIds.Add(tagId);
        }
        StateHasChanged();
    }

    private async Task SaveTask()
    {
        if (string.IsNullOrWhiteSpace(taskForm.Title) || string.IsNullOrEmpty(taskForm.AssigneeId))
        {
            return;
        }

        isSaving = true;
        StateHasChanged();

        try
        {
            if (editingTask != null)
            {
                await TaskService.UpdateTaskAsync(editingTask.Id, taskForm, selectedTagIds);
            }
            else
            {
                taskForm.CreatorId = currentUserId ?? "";
                await TaskService.CreateTaskAsync(taskForm, selectedTagIds);
            }
            
            CloseModal();
            await LoadTasks();
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private async Task UpdateStatus(TaskItem task, string newStatus)
    {
        await TaskService.UpdateTaskStatusAsync(task.Id, newStatus);
        await LoadTasks();
    }

    private async Task DeleteTask(TaskItem task)
    {
        await TaskService.DeleteTaskAsync(task.Id);
        await LoadTasks();
    }

    private string GetNextStatus(string currentStatus)
    {
        return currentStatus switch
        {
            "Pending" => "In Progress",
            "In Progress" => "Completed",
            _ => currentStatus
        };
    }

    private string GetPriorityClass(string priority)
    {
        return priority switch
        {
            "Urgent" => "px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700",
            "High" => "px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700",
            "Normal" => "px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700",
            "Low" => "px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700",
            _ => "px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700"
        };
    }

    private string GetStatusClass(string status)
    {
        return status switch
        {
            "Completed" => "px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700",
            "In Progress" => "px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700",
            "Pending" => "px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700",
            _ => "px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700"
        };
    }

    private string GetTagClass(string color)
    {
        return color switch
        {
            "red" => "px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-700",
            "orange" => "px-2 py-1 text-xs font-medium rounded-full bg-orange-100 text-orange-700",
            "yellow" => "px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700",
            "green" => "px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-700",
            "teal" => "px-2 py-1 text-xs font-medium rounded-full bg-teal-100 text-teal-700",
            "blue" => "px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700",
            "indigo" => "px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700",
            "purple" => "px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-700",
            "pink" => "px-2 py-1 text-xs font-medium rounded-full bg-pink-100 text-pink-700",
            _ => "px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-700"
        };
    }

    private string GetTagClassSelected(string color)
    {
        return color switch
        {
            "red" => "px-3 py-1.5 text-xs font-medium rounded-full bg-red-500 text-white ring-2 ring-red-300",
            "orange" => "px-3 py-1.5 text-xs font-medium rounded-full bg-orange-500 text-white ring-2 ring-orange-300",
            "yellow" => "px-3 py-1.5 text-xs font-medium rounded-full bg-yellow-500 text-white ring-2 ring-yellow-300",
            "green" => "px-3 py-1.5 text-xs font-medium rounded-full bg-green-500 text-white ring-2 ring-green-300",
            "teal" => "px-3 py-1.5 text-xs font-medium rounded-full bg-teal-500 text-white ring-2 ring-teal-300",
            "blue" => "px-3 py-1.5 text-xs font-medium rounded-full bg-blue-500 text-white ring-2 ring-blue-300",
            "indigo" => "px-3 py-1.5 text-xs font-medium rounded-full bg-indigo-500 text-white ring-2 ring-indigo-300",
            "purple" => "px-3 py-1.5 text-xs font-medium rounded-full bg-purple-500 text-white ring-2 ring-purple-300",
            "pink" => "px-3 py-1.5 text-xs font-medium rounded-full bg-pink-500 text-white ring-2 ring-pink-300",
            _ => "px-3 py-1.5 text-xs font-medium rounded-full bg-gray-500 text-white ring-2 ring-gray-300"
        };
    }

    private string GetTagClassUnselected(string color)
    {
        return color switch
        {
            "red" => "px-3 py-1.5 text-xs font-medium rounded-full bg-red-100 text-red-700 hover:bg-red-200 cursor-pointer",
            "orange" => "px-3 py-1.5 text-xs font-medium rounded-full bg-orange-100 text-orange-700 hover:bg-orange-200 cursor-pointer",
            "yellow" => "px-3 py-1.5 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700 hover:bg-yellow-200 cursor-pointer",
            "green" => "px-3 py-1.5 text-xs font-medium rounded-full bg-green-100 text-green-700 hover:bg-green-200 cursor-pointer",
            "teal" => "px-3 py-1.5 text-xs font-medium rounded-full bg-teal-100 text-teal-700 hover:bg-teal-200 cursor-pointer",
            "blue" => "px-3 py-1.5 text-xs font-medium rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 cursor-pointer",
            "indigo" => "px-3 py-1.5 text-xs font-medium rounded-full bg-indigo-100 text-indigo-700 hover:bg-indigo-200 cursor-pointer",
            "purple" => "px-3 py-1.5 text-xs font-medium rounded-full bg-purple-100 text-purple-700 hover:bg-purple-200 cursor-pointer",
            "pink" => "px-3 py-1.5 text-xs font-medium rounded-full bg-pink-100 text-pink-700 hover:bg-pink-200 cursor-pointer",
            _ => "px-3 py-1.5 text-xs font-medium rounded-full bg-gray-100 text-gray-700 hover:bg-gray-200 cursor-pointer"
        };
    }
}
