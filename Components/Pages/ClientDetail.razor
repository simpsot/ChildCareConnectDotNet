@page "/clients/{ClientId}"
@using ChildCareConnect.Services
@using ChildCareConnect.Models
@inject ClientService ClientService
@inject UserService UserService
@inject PhoneNumberService PhoneNumberService
@inject HouseholdMemberService HouseholdMemberService
@inject NavigationManager Navigation

<PageTitle>Client Details - ChildCare Connect</PageTitle>

@if (client == null)
{
    <div class="flex items-center justify-center h-screen">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-teal-600 mx-auto mb-4"></div>
            <p class="text-gray-500">Loading client details...</p>
        </div>
    </div>
}
else
{
    <div class="max-w-4xl space-y-6">
        <div class="flex items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <button @onclick="GoBack" class="p-2 hover:bg-gray-100 rounded-lg">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">@client.Name</h1>
                    <p class="text-gray-500 mt-1">@client.Contact - Primary Contact</p>
                </div>
            </div>
            @if (!isEditMode)
            {
                <button @onclick="ToggleEditMode" class="inline-flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                    Edit
                </button>
            }
        </div>

        <!-- Basic Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Basic Information</h2>
            
            @if (!isEditMode)
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Family Name</p>
                        <p class="text-lg text-gray-900 mt-1">@client.Name</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Primary Contact</p>
                        <p class="text-lg text-gray-900 mt-1">@client.Contact</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Date of Birth</p>
                        <p class="text-lg text-gray-900 mt-1">@(client.DateOfBirth?.ToString("MMM dd, yyyy") ?? "Not provided")</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Gender</p>
                        <p class="text-lg text-gray-900 mt-1">@(string.IsNullOrEmpty(client.Gender) ? "Not provided" : client.Gender)</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Race/Ethnicity</p>
                        <p class="text-lg text-gray-900 mt-1">@(string.IsNullOrEmpty(client.Race) ? "Not provided" : client.Race)</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Nationality</p>
                        <p class="text-lg text-gray-900 mt-1">@(string.IsNullOrEmpty(client.Nationality) ? "Not provided" : client.Nationality)</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Citizenship Status</p>
                        <p class="text-lg text-gray-900 mt-1">@(string.IsNullOrEmpty(client.CitizenshipStatus) ? "Not provided" : client.CitizenshipStatus)</p>
                    </div>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Family Name</label>
                        <input type="text" @bind="client.Name" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Primary Contact</label>
                        <input type="text" @bind="client.Contact" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                        <input type="date" @bind="client.DateOfBirth" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select @bind="client.Gender" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="">Select...</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Non-binary">Non-binary</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Race/Ethnicity</label>
                        <input type="text" @bind="client.Race" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nationality</label>
                        <input type="text" @bind="client.Nationality" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Citizenship Status</label>
                        <select @bind="client.CitizenshipStatus" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="">Select...</option>
                            <option value="U.S. Citizen">U.S. Citizen</option>
                            <option value="Permanent Resident">Permanent Resident</option>
                            <option value="Temporary Resident">Temporary Resident</option>
                            <option value="Undocumented">Undocumented</option>
                        </select>
                    </div>
                </div>
            }
        </div>

        <!-- Contact Information -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 space-y-4">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Contact Information</h2>
            
            @if (phoneNumbers.Any())
            {
                <div>
                    <p class="text-sm font-medium text-gray-500 mb-2">Phone Numbers</p>
                    <div class="space-y-2">
                        @foreach (var phone in phoneNumbers)
                        {
                            <div class="p-3 bg-gray-50 rounded-lg flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-900">@phone.Phone</p>
                                    <p class="text-sm text-gray-500">@phone.PhoneType</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
            else
            {
                <div>
                    <p class="text-sm font-medium text-gray-500">Phone Numbers</p>
                    <p class="text-lg text-gray-900 mt-1">Not provided</p>
                </div>
            }

            @if (CurrentUser?.CanManageUsers == true)
            {
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500">Social Security Number (SSN)</p>
                            <p class="text-lg text-gray-900 mt-1">
                                @if (showSSN)
                                {
                                    <span class="font-mono">@decryptedSSN</span>
                                }
                                else
                                {
                                    <span class="font-mono">@client.MaskedSSN</span>
                                }
                            </p>
                        </div>
                        <button type="button" @onclick="ToggleSSNVisibility" class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 text-sm font-medium">
                            @(showSSN ? "Hide" : "Show")
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">⚠️ Access to SSN is restricted and logged for compliance</p>
                </div>
            }
            else
            {
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-700 text-sm">
                        <p>You do not have permission to view sensitive information. Contact an administrator if you need SSN access.</p>
                    </div>
                </div>
            }
        </div>

        <!-- Household Members -->
        @if (householdMembers.Any())
        {
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Household Members</h2>
                <div class="space-y-3">
                    @foreach (var member in householdMembers)
                    {
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-medium text-gray-900">@member.Name</p>
                                    <p class="text-sm text-gray-500 mt-1">@(member.Relationship?.Name ?? "Unknown Relationship")</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Case Management -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Case Management</h2>
            
            @if (!isEditMode)
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-medium text-gray-500">Case Manager</p>
                        <p class="text-lg text-gray-900 mt-1">@(client.CaseManager?.Name ?? "Unassigned")</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Status</p>
                        <p class="text-lg mt-1">
                            <span class="@GetStatusBadgeClass(client.Status)">@client.Status</span>
                        </p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Last Contact</p>
                        <p class="text-lg text-gray-900 mt-1">@(string.IsNullOrEmpty(client.LastContact) ? "No contact recorded" : client.LastContact)</p>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Registered On</p>
                        <p class="text-lg text-gray-900 mt-1">@client.CreatedAt.ToString("MMM dd, yyyy")</p>
                    </div>
                </div>
            }
            else
            {
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select @bind="client.Status" class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="Active">Active</option>
                            <option value="Pending">Pending</option>
                            <option value="Inactive">Inactive</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>
                    <div>
                        <p class="text-sm font-medium text-gray-500">Registered On</p>
                        <p class="text-lg text-gray-900 mt-1">@client.CreatedAt.ToString("MMM dd, yyyy")</p>
                    </div>
                </div>
            }
        </div>

        <div class="flex gap-4">
            @if (isEditMode)
            {
                <button type="button" @onclick="CancelEdit" class="px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="button" @onclick="SaveChanges" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                    Save Changes
                </button>
            }
            else
            {
                <button @onclick="GoBack" class="px-4 py-2 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50">
                    Back to Clients
                </button>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public string? ClientId { get; set; }

    [CascadingParameter]
    public User? CurrentUser { get; set; }

    private Client? client;
    private Client? clientBeforeEdit;
    private List<HouseholdMember> householdMembers = new();
    private List<PhoneNumber> phoneNumbers = new();
    private bool showSSN = false;
    private bool isEditMode = false;
    private string decryptedSSN = "";

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(ClientId))
        {
            Navigation.NavigateTo("/clients");
            return;
        }

        client = await ClientService.GetClientWithHouseholdMembersAsync(ClientId);
        
        if (client == null)
        {
            Navigation.NavigateTo("/clients");
            return;
        }

        householdMembers = client.HouseholdMembers.ToList();
        phoneNumbers = await PhoneNumberService.GetPhoneNumbersByClientAsync(ClientId);
    }

    private void ToggleSSNVisibility()
    {
        if (!showSSN && !string.IsNullOrEmpty(client?.SSN))
        {
            // Decrypt SSN only when showing
            var decrypted = EncryptionService.DecryptSSN(client.SSN);
            // Format as XXX-XX-XXXX
            decryptedSSN = FormatSSN(decrypted);
            showSSN = true;
        }
        else
        {
            showSSN = false;
            decryptedSSN = "";
        }
    }

    private string FormatSSN(string ssn)
    {
        // Remove any non-digits
        var digitsOnly = new string(ssn.Where(char.IsDigit).ToArray());
        
        // Format as XXX-XX-XXXX if it has 9 digits
        if (digitsOnly.Length == 9)
        {
            return $"{digitsOnly.Substring(0, 3)}-{digitsOnly.Substring(3, 2)}-{digitsOnly.Substring(5, 4)}";
        }
        
        return ssn;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/clients");
    }

    private void ToggleEditMode()
    {
        if (!isEditMode)
        {
            clientBeforeEdit = new Client
            {
                Id = client!.Id,
                Name = client.Name,
                Contact = client.Contact,
                Gender = client.Gender,
                Race = client.Race,
                Nationality = client.Nationality,
                CitizenshipStatus = client.CitizenshipStatus,
                Status = client.Status,
                DateOfBirth = client.DateOfBirth
            };
            isEditMode = true;
        }
    }

    private void CancelEdit()
    {
        if (clientBeforeEdit != null)
        {
            client!.Name = clientBeforeEdit.Name;
            client.Contact = clientBeforeEdit.Contact;
            client.Gender = clientBeforeEdit.Gender;
            client.Race = clientBeforeEdit.Race;
            client.Nationality = clientBeforeEdit.Nationality;
            client.CitizenshipStatus = clientBeforeEdit.CitizenshipStatus;
            client.Status = clientBeforeEdit.Status;
            client.DateOfBirth = clientBeforeEdit.DateOfBirth;
        }
        isEditMode = false;
        StateHasChanged();
    }

    private async Task SaveChanges()
    {
        if (client == null || string.IsNullOrEmpty(ClientId)) return;
        try
        {
            await ClientService.UpdateClientAsync(ClientId, client);
            // Reload client data to ensure consistency
            client = await ClientService.GetClientWithHouseholdMembersAsync(ClientId);
            householdMembers = client?.HouseholdMembers.ToList() ?? new();
            phoneNumbers = await PhoneNumberService.GetPhoneNumbersByClientAsync(ClientId);
            isEditMode = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating client: {ex.Message}");
            StateHasChanged();
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        var baseClass = "inline-flex px-2 py-1 text-xs font-medium rounded-full ";
        return status switch
        {
            "Active" => baseClass + "bg-green-100 text-green-700",
            "Pending" => baseClass + "bg-yellow-100 text-yellow-700",
            "Inactive" => baseClass + "bg-gray-100 text-gray-700",
            "On Hold" => baseClass + "bg-orange-100 text-orange-700",
            _ => baseClass + "bg-gray-100 text-gray-700"
        };
    }
}
